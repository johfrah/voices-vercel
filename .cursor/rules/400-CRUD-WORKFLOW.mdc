---
description: Nuclear CRUD Workflow & ID-First Handshake for Project Atomic (2026)
globs: **/*.{ts,tsx}
alwaysApply: true
---

# ðŸš€ NUCLEAR WORKFLOW: ID-FIRST ENGINE (2026)

**Mandaat:** ZERO DRIFT, ID-FIRST INTEGRITY

## 1. DE ARCHITECTUUR (Source of Truth)
Wij werken in een volledig ontkoppeld model waarbij de Supabase-database de enige waarheid is.

- **Frontend:** Next.js (App Router) in `1-SITE/apps/web/`.
- **Database:** Drizzle ORM in `1-SITE/packages/database/`.
- **Media:** Supabase Storage gesynchroniseerd met `1-SITE/apps/web/public/assets/`.
- **Routing:** `slug_registry` tabel in Supabase (Handshake ID).

## 2. ID-FIRST HANDSHAKE (De Grondwet)
Het gebruik van slugs of namen voor interne logica is STRIKT VERBODEN.

1.  **Resolve First**: Elke inkomende request (URL slug) moet DIRECT worden geresolveerd naar een `entity_id` (UUID) via de `slug_registry`.
2.  **Internal Logic**: Gebruik UITSLUITEND `entity_id`, `world_id`, `market_id` en `journey_id` voor database queries, props en state management.
3.  **Cross-Market Summation**: Prijzen en configuraties worden berekend op basis van de `market_id`. Gebruik de `MarketManager` voor "Global-First, Exception by Market" logica.

## 3. DAGELIJKSE WORKFLOW

### A. Ontwikkelen (ID-Only)
1.  **Linter-First**: Draai ALTIJD `npm run lint` of `npm run type-check` voor elke commit.
2.  **Type-Safety**: Geen `any`. Gebruik de types uit `@/types/` of genereer ze via Drizzle.
3.  **LayoutInstruments**: Gebruik UITSLUITEND instrumenten uit de catalogus (`310-LAYOUT-INSTRUMENTS.mdc`).

### B. Database Wijzigingen (Drizzle)
1.  Pas het schema aan in `1-SITE/packages/database/src/schema/`.
2.  Genereer migraties en push naar Supabase via de CLI.
3.  **Atomic CRUD**: Data-aanpassingen gebeuren via Server Actions of API routes, ALTIJD met ID-validatie.

### C. Deployment (Vercel)
1.  Verhoog de versie in `package.json`, `Providers.tsx` en `api/admin/config/route.ts`.
2.  Voer `npm run check:pre-vercel` uit.
3.  Commit met `vX.Y.Z: [Bericht]` en push naar GitHub.
4.  Valideer live via `npx tsx 3-WETTEN/scripts/forensic-audit.ts`.

## 4. ISO-FIRST MANDATE
Gebruik ALTIJD officiÃ«le ISO-codes voor talen en markten.
- **Talen**: `nl-BE`, `nl-NL`, `fr-BE`, `en-GB`, etc.
- **Markten**: Gebruik `market_code` (bijv. `BE`, `NL`) voor configuratie-mapping.

## 5. NUCLEAR LOCKS
Gebruik `is_manually_edited: true` in de database voor records die NOOIT door AI of scripts overschreven mogen worden.

"Data is vloeibaar, maar de ID is een anker." - Chris/Autist
